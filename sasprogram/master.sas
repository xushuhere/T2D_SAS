/* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *                                                                     
* Program Name:  master.sas                          
*         Date:  11/16/2018                                               
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
* Purpose:  The purpose of the program is for RCR T2D Cohort Identification and Characteristics 
*           Query analyzes data from PCORnet Common Data Model (CDM) v4.1 compliant tables.
*
*  Inputs:  
*           1) CDM tables:                                                                                                                      
*              demographic                                                            
*              diagnosis                                                                                                        
*              encounter                                                              
*              lab_result_cm                                            
*              procedures                                                             
*              prescribing 
*
*           2) SAS supporting files at /infolder
*              code_reference.cpt 
*
*           3) SAS programs at /infolder/macros
*              master_part1.sas
*              master_part2.sas
*              define_concepts.sas
*                            
*  Output:
*           1) Output files from master_part1 stored in /dmlocal 
*           2) SAS datasets from master_part2 stored in /dmtable
*           3) Files Returned to the DRN OC stored in /dmoutput 
* 
*  Requirement:  
*               1) Program run in SAS 9.3 or higher
*             
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * */;
options errorabend validvarname=upcase;

/********** ENTER FOLDER CONTAINING INPUT DATA FILES AND MSCDM DATA ***************************************/;	
%LET indata=/aaa/bbb/;

/********** ENTER ROOT DIRECTORY TO SUB-DIRECTORY FOR THE QUERY PACKAGE  ***************************************/;
%LET qpath=/xxx/yyy/;	

/*****************************************************************************************************/
/**************************** PLEASE DO NOT EDIT CODE BELOW THIS LINE ********************************/
/*****************************************************************************************************/

/* Set query period */
%let query_from= '01jan2004'd;
%let query_to= '31dec2019'd;

/* Set threshold value */
%let THRESHOLD=11;

/*DPP4 GLP1 SGLT2 Sulfonylureas codes*/
%LET RXNORM =
/*GLP1*/'1551300','1551306','1990871','1653625','1163790','604749','1242967','847911','1544918','1169415','847908','1990870','744862','1242962','1242963','1653616','1653611','847912','604754','1544917','1990867',
'1990865','1242964','1359802','1360454','1242968','1242966','1544919','1653613','604752','1359640','744865','604751','604748','847914','1990868','744863','847915','1544920','1990866','847917','1990869','847916',
'1544916','1242965','1242961','1653610','744864','60548','1653614','847910','1653619','1359979','847909','604753','604750','847913','1990864','1360495','897122','897126','897123','1360105','1860164','1598268',
'1163230','1186578','1598267','897121','897120','1598264','1598265','1653600','1653594','475968','1598269','1653597','897125','897124','1598266','1440051','1858991','1860172','1860170','1860173','1860167','1727493',
'1860166','1860174','1860169','1860165','1858992','1858995','1858997','1858998','1859000','1859001','1859002','1858994','1858993',/*SGLT2*/'1602108','1602119','1602109','1602114','1602110','1602115','1602113',
'1598392','1602106','1602112','1602118','1602120','1602111','1602107','1992818','1992806','1992807','1992808','1992819','1992809','1992810','1992674','1992672','1992701','1992681','1992698','1992699','1992702',
'1992694','1992685','1992684','1992683','1992825','1992687','1992682','1992693','1992700','1992695','1992686','1992703','1992691','1545153','1810999','1811005','1545164','1811010','1545155','1811007','1545151',
'1811013','1810997','1810998','1545157','1545156','1811004','1545162','1810996','1545163','1545165','1545150','1545158','1811009','1545147','1811012','1545159','1811008','1811006','1545149','1545148','1811000',
'1545152','1545154','1545146','1811003','1811002','1811001','1811011','1545166','1545161','1940500','1593059','1940496','1593774','1592716','1593833','1593835','1593069','1593830','1940499','1593071','1593829',
'1593832','1593057','1593072','1592710','1592709','1593058','1592713','1940497','1940498','1592717','1593068','1593073','1593775','1593828','1593831','1593827','1593070','1593776','1486436','1593826','1592722',
'1862698','1664324','1665367','1862685','1664315','1862702','1862694','1862693','1862690','1664318','1862700','1665369','1862701','1664312','1862697','1862687','1664316','1664326','1862692','1862689','1862686',
'1862695','1664321','1664314','1862691','1862703','1862684','1862688','1664323','1862696','1664325','1664311','1665368','1664328','1664313','1664319','1664327','1664320','1862699','1664317','1925495','1925500',
'2169275','1727500','2169276','1925504','1925497','1925499','2169274','1925503','1925502','1925496','1925501','1925498','1373470','1373466','1546031','1373468','1373469','1373459','1373463','1373462','1373471',
'1373458','1545160','1373461','1545145','1373465','1373472','1373460','1373473','1373464','1373467','1486967','1488564','1486971','1486980','1486972','1486970','1486966','1486975','1488574','1534344','1486979',
'1534343','1534397','1486973','1486981','1488566','1488568','1940495','1488565','1486978','1488573','1488567','1488569','1486976','1486974','1486977','1545658','1664322','1545656','1545664','1545657','1545667',
'1545666','1545663','1545660','1545661','1545659','1545662','1545653','1545665','1664310','1545654','1545655','1545668','1992821','1992812','1992820','1992829','1992831','1992827','1992830','1992835','1992814',
'1992813','1992832','1992837','1992823','1992822','1992836','1992824','1992826','1992815','1992816','1992828','1992811',/*DPP4*/'1368001','1368035','1368034','1368003','1368007','1368004','1368020','1368008',
'1368036','1368012','1368006','1368018','1368002','1368010','1368019','1368005','1368017','1368011','1368009','1368000','1368033','1243015','1100704','1100705','1179164','1164671','1179163','1100703','1100706',
'1100701','1100699','1100700','1164670','1100702','1602108','1602119','1602109','1602114','1602110','1602115','1602113','1598392','1602106','1602112','1602118','1602120','1602111','1602107','858042','857974',
'858035','858041','858044','1158518','1546030','858034','858039','1043560','1158519','858036','858038','1181730','1181729','858043','858040','858037','1189823','1189827','1312415','665033','1189812','665032',
'1167814','1189804','665039','1189811','1312409','1159662','1312429','1312422','1189813','748762','1312423','665041','1189814','665037','1189824','1189810','1312411','1312418','665043','1189801','1312416','665040',
'665035','1189808','593411','1189800','665034','665042','1189807','665036','1189802','638596','1312426','1312425','1189806','1189821','1167815','1189818','1189803','1159663','1372754','1312419','665031','665038',
'621590','1312412','665044','1368397','1372692','1368388','1368386','1368393','1368383','1368396','1368394','1368381','1368398','1368395','1368392','1368384','1368391','1368382','1368385','1368387','1243035',
'1372706','1243018','1796093','1243040','1243026','1243023','1243036','1243017','1243022','1243033','1796094','1796090','1243029','1796098','1243027','1796095','1243037','1243028','1796092','1243020','1796089',
'1796088','1243039','1243021','1796091','1243030','1243034','1796097','1796096','1243016','1243019','1243038','1043576','1043564','1043574','1043569','1043567','1043571','1172860','1161606','1043570','1043580',
'1043578','1043562','1043581','1043582','1172861','1043568','1043579','1043584','1043561','1043565','1043583','1161605','1372730','1043572','1043575','1043566','1043563','1043573','748764','757606','1243844',
'1243842','1243830','861770','1243849','705137','861771','757608','1243843','861821','1161607','1243846','700516','1161608','1243848','748763','1243833','700518','757604','861820','861769','1243850','1243834',
'704929','1243827','700517','1243847','757603','748765','1167810','1372738','705134','1167811','1243845','757605','1243835','1243828','705135','705138','861819','729717','1243839','757607','757602','757601',
'1243826','705136','1243829','1925495','1925500','2169275','1727500','2169276','1925504','1925497','1925499','2169274','1925503','1925502','1925496','1925501','1925498','1992821','1992812','1992820','1992829',
'1992831','1992827','1992830','1992835','1992814','1992813','1992832','1992837','1992823','1992822','1992836','1992824','1992826','1992815','1992816','1992828','1992811','1368439','1368413','1368432','1368436',
'1368406','1368437','1368400','1368434','1368418','1368417','1368409','1368425','1368440','1368416','1368433','1368423','1368403','1368435','1368427','1368405','1368402','1368419','1368411','1368441','1368426',
'1368410','1368399','1368412','1368444','1368424','1368401','1368404','1368438','1368430','1368431','1372717','1368420',/*Sulfonylureas*/'1155470','371467','430105','198291','1183954','362611','315274','1183958',
'1157122','2404','1155471','313419','1177973','197495','374149','10635','1179113','316835','542032','542030','566055','105369','201919','1153126','353028','332808','10633','369304','1007582','197496','197307',
'207954','1169680','220338','564035','368696','313418','1176497','573945','1157643','209204','375952','568686','568685','315239','568684','207955','151616','218942','214107','315273','1157642','376868','214106',
'207953','316832','1173427','252259','575377','1179112','369297','438506','1157644','542029','374152','221173','316833','208012','1155472','368586','1176496','246523','316836','1183952','542031','370529','227211',
'432853','568742','198293','1153127','315647','371465','1157121','1173428','351452','203681','198292','316834','368714','1169681','197306','315648','573946','1155469','333394','332810','245266','198294','569831',
'328851','1177974','173','372319','153842','199246','565410','25789','153845','1361494','1170663','315978','199247','1170664','1361492','367762','153844','380849','1157245','1361495','315979','153592','565409',
'153843','1157244','317637','565408','1361493','565327','199245','153591','647208','647239','647237','1166404','647236','731457','668562','731454','1157241','731460','1157240','1166403','731463','731461','668556',
'647235','731456','731462','668554','668555','668563','731455','602544','847708','847717','615212','847719','1157243','706896','615210','847711','847722','847713','706933','847709','847723','847720','847712',
'847718','847724','1175658','615211','847714','847707','1175659','847721','615213','606253','847710','847715','607816','615214','847705','706932','602543','1157242','707181','615918','847706','615919','602550',
'707182','847716','602549','706895','1860171','865567','844499','372320','1171233','700836','105373','574533','566719','317379','844827','865573','566056','310490','865569','217360','865574','310488','201922',
'566057','203679','205829','1171234','261311','151822','844498','379805','566721','1171247','865568','310489','205828','205830','700835','1179292','566718','315980','379801','844824','1171246','865571','315107',
'844809','1165207','1165208','379803','564038','201921','203680','4821','369500','314006','1179291','205831','865570','379802','865572','379804','844769','330349','566720','151725','379571','1186170','669982',
'246524','1156200','315990','1175880','379559','201064','566762','564036','369562','205876','1171930','205872','310539','1186169','205879','151466','152651','1171148','1171149','1008873','565675','1156198',
'669981','1178369','1175878','201061','1178082','669986','252960','225613','1178083','565672','440287','1175879','881408','881407','261532','881410','105371','669987','205880','1179741','201062','542065','574571',
'669983','1170867','565673','430102','563154','440285','261351','261974','369373','205877','201059','541896','205874','379572','566764','369557','541897','541898','881404','565669','881411','379570','1171934',
'1171920','197737','542066','315992','260286','4815','201057','566768','566763','315989','315987','881409','1175881','1170866','93312','310537','201063','564037','669980','205873','331496','669985','105372','881406',
'565674','542067','203289','1179740','1156199','315988','203296','1168162','102845','565667','1171933','368204','566761','315991','201060','205881','1156201','310534','565671','379568','372333','260287','565670',
'574090','372334','314000','565668','1171929','574612','203295','310536','201056','669984','566765','217370','1168163','430103','201058','566769','151615','217364','566766','574089','881405','430104','1171919',
'1178368','205875','379565','246391','566770','440286','1155467','432366','1007411','246522','432780','371466','849592','861740','849583','861737','1185624','861732','575998','351274','861731','849593','849591',
'861738','351275','1165205','861736','849585','352381','849587','861741','849584','1165206','352301','575997','849594','849586','575996','351273','861733','849590','352300','368567','352764','352302','378730',
'849589','849588','1185049','861742','861751','284432','861748','284433','1156197','861747','284431','861743','310533','574870','861757','310538','374635','429841','1165845','1171249','1171248','861744','285129',
'574869','574871','861755','861756','310535','861749','861746','861752','861753','284743','861750','250919','368169','861754','861745';

/********************************************************************************
*- Set LIBNAMES for INPUT FILES AND MSCDM DATA
*******************************************************************************/
libname indata "&indata." access=readonly;
libname infolder "&qpath.infolder/";
/********************************************************************************
*- Set LIBNAME for FINAL DATASETS from PART1 TO BE KEPT LOCAL AT THE PARTNER SITE
*********************************************************************************/
libname dmlocal "&qpath.dmlocal/";
/********************************************************************************
*- Set LIBNAME for FINAL DATASETS from PART2 TO BE KEPT LOCAL AT THE PARTNER SITE 
*********************************************************************************/;
libname dmtable "&qpath.dmtable/";
/********************************************************************************
*- Set LIBNAME for CONTAINING SUMMARY FILES TO BE EXPORTED TO OPERATION CENTER
*********************************************************************************/;
libname dmoutput "&qpath.dmoutput/";
/********************************************************************************
*- Import transport file for all reference data sets
*********************************************************************************/;
filename tranfile "&qpath.infolder/code_reference.cpt";
proc cimport infile=tranfile library=infolder; run;
/********************************************************************************;
*- Create macro variable from DataMart ID 
********************************************************************************/;
data _null_;
     set indata.harvest;
     call symput("DMID",strip(datamartid));
run;
/********************************************************************************
* Submit query programs
********************************************************************************/;
%include "&qpath.infolder/macros/define_concepts.sas";
%include "&qpath.infolder/macros/master_part1.sas";
/* Flush datasets in WORK ENVIRONMENT */
proc datasets nolist nodetails lib=work kill memtype=data; quit;

%include "&qpath.infolder/macros/master_part2.sas";

